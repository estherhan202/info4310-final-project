<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MBTI by Country</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 2rem;
    }

    svg {
      margin-top: 2rem;
    }

    .bar {
      fill: steelblue;
    }

    .axis text {
      font-size: 12px;
    }

    .country {
      stroke: #fff;
      stroke-width: 0.5px;
    }

    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      pointer-events: none;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h2>MBTI Distribution by Country</h2>
  <label for="countrySelect">Select a country:</label>
  <select id="countrySelect"></select>

  <svg id="barchart" width="800" height="400"></svg>
  <svg id="map" width="960" height="500"></svg>

  <div class="tooltip" style="opacity: 0;"></div>
  <div id="sunburst"></div>

  <script>
    const mbtiTypes = [
      "ESTJ", "ESFJ", "INFP", "ENFP", "ESTP", "ISTJ", "INTP", "INFJ",
      "ISFP", "ENTJ", "ESFP", "ENTP", "ENFJ", "INTJ", "ISFJ", "ISTP"
    ];

    const tooltip = d3.select(".tooltip");
    const svgMap = d3.select("#map");
    const svgBar = d3.select("#barchart");
    const margin = { top: 20, right: 20, bottom: 50, left: 60 };
    const width = +svgBar.attr("width") - margin.left - margin.right;
    const height = +svgBar.attr("height") - margin.top - margin.bottom;
    const chart = svgBar.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const y = d3.scaleLinear().range([height, 0]);
    const x = d3.scaleBand().range([0, width]).padding(0.2);
    const xAxis = chart.append("g").attr("transform", `translate(0, ${height})`);
    const yAxis = chart.append("g");

    // Load CSV and GeoJSON data
    Promise.all([
      d3.csv("countries.csv"),
      d3.json("countries.geojson")
    ]).then(([csvData, geoData]) => {
      // Extract and normalize country names from CSV
      const csvCountries = csvData.map(d => d.Country.trim().toLowerCase());

      // Extract and normalize country names from GeoJSON
      const geoCountries = geoData.features.map(d => d.properties.name.trim().toLowerCase());

      // Identify countries in CSV but not in GeoJSON
      const csvNotInGeo = csvCountries.filter(name => !geoCountries.includes(name));
      console.log("Countries in CSV but not in GeoJSON:", csvNotInGeo);

      // Identify countries in GeoJSON but not in CSV
      const geoNotInCSV = geoCountries.filter(name => !csvCountries.includes(name));
      console.log("Countries in GeoJSON but not in CSV:", geoNotInCSV);
    }).catch(error => {
      console.error("Error loading data:", error);
    });

    Promise.all([
      d3.csv("countries.csv"),
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json")
    ]).then(([data, world]) => {
      const countries = data.map(d => d.Country);
      const select = d3.select("#countrySelect");

      select.selectAll("option")
        .data(countries)
        .enter()
        .append("option")
        .text(d => d)
        .attr("value", d => d);

      select.on("change", () => updateChart(select.property("value")));
      updateChart(countries[0]);

      const geoData = topojson.feature(world, world.objects.countries);
      const projection = d3.geoNaturalEarth1().scale(160).translate([480, 250]);
      const path = d3.geoPath().projection(projection);

      const mbtiTotals = {};
      data.forEach(row => {
        let sum = 0;
        mbtiTypes.forEach(type => {
          sum += (+row[`${type}-A`] || 0) + (+row[`${type}-T`] || 0);
        });
        mbtiTotals[row.Country] = sum;
      });

      const color = d3.scaleSequential(d3.interpolateBlues)
        .domain([0, d3.max(Object.values(mbtiTotals))]);

      svgMap.selectAll("path")
        .data(geoData.features)
        .join("path")
        .attr("d", path)
        .attr("class", "country")
        .attr("fill", d => {
          const name = d.properties.name;
          return mbtiTotals[name] ? color(mbtiTotals[name]) : "#eee";
        })
        .on("mouseover", function (event, d) {
          const name = d.properties.name;
          if (mbtiTotals[name]) {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`<strong>${name}</strong><br>Total MBTI entries: ${mbtiTotals[name]}`)
              .style("left", (event.pageX + 5) + "px")
              .style("top", (event.pageY - 28) + "px");
          }
        })
        .on("mouseout", function () {
          tooltip.transition().duration(500).style("opacity", 0);
        })
        .on("click", function (event, d) {
          const name = d.properties.name;
          console.log("Country clicked:", name);
          if (mbtiTotals[name]) {
            select.property("value", name);
            updateChart(name);
          }
        });

      function updateChart(countryName) {
        const row = data.find(d => d.Country === countryName);
        const values = {};

        mbtiTypes.forEach(type => {
          const a = +row[`${type}-A`] || 0;
          const t = +row[`${type}-T`] || 0;
          values[type] = a + t;
        });

        const dataset = mbtiTypes.map(type => ({ type, value: values[type] }));

        x.domain(mbtiTypes);
        y.domain([0, d3.max(dataset, d => d.value)]);

        xAxis.transition().duration(500).call(d3.axisBottom(x));
        yAxis.transition().duration(500).call(d3.axisLeft(y).ticks(5));

        const bars = chart.selectAll(".bar").data(dataset, d => d.type);

        bars.enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", d => x(d.type))
          .attr("width", x.bandwidth())
          .attr("y", height)
          .attr("height", 0)
          .merge(bars)
          .transition()
          .duration(800)
          .attr("x", d => x(d.type))
          .attr("width", x.bandwidth())
          .attr("y", d => y(d.value))
          .attr("height", d => height - y(d.value));

        bars.exit().remove();
      }
    });


  </script>
</body>

</html>