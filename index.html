<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Handwriting Features vs Personality Traits</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
    }

    h1 {
      text-align: center;
    }

    #controls {
      margin-bottom: 30px;
      text-align: center;
    }

    #radarChart {
      display: flex;
      justify-content: center;
    }

    select {
      min-width: 200px;
      height: 120px;
    }

    .legend {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <h1>Handwriting Feature Correlation with Personality</h1>
  <div id="controls">
    <label for="featureSelect">Choose Feature(s):</label><br>
    <small>(Use Ctrl/Cmd + click for multiple)</small><br>
    <select id="featureSelect" multiple></select>
  </div>

  <div id="radarChart"></div>
  <div class="legend" id="legend"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    d3.csv("results.csv").then(data => {
      const features = [...new Set(data.map(d => d.Feature))];
      const traits = ["Extraversion", "Agreeableness", "Openness", "Neuroticism", "Conscientiousness"];
      const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
      const featureSelect = d3.select("#featureSelect");

      featureSelect.selectAll("option")
        .data(features)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      // Initial draw
      updateChart([features[0]]);

      featureSelect.on("change", function () {
        const selected = Array.from(this.selectedOptions).map(opt => opt.value);
        updateChart(selected);
      });

      function updateChart(selectedFeatures) {
        const filtered = data.filter(d => selectedFeatures.includes(d.Feature));

        // Reorganize to group by feature
        const featureData = selectedFeatures.map(feature => {
          const entry = traits.map(trait => {
            const match = filtered.find(d => d.Feature === feature && d.Trait === trait);
            return {
              axis: trait,
              value: match ? +match.Correlation : 0,
              significant: match ? match.Significant === "True" : false
            };
          });
          return { name: feature, values: entry };
        });

        drawRadar(featureData);
        drawLegend(featureData);
      }

      function drawRadar(datasets) {
        d3.select("#radarChart").selectAll("*").remove();

        const width = 500, height = 500;
        const radius = Math.min(width, height) / 2 - 50;
        const svg = d3.select("#radarChart")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", `translate(${width / 2},${height / 2})`);

        const angleSlice = 2 * Math.PI / traits.length;

        // Axes
        traits.forEach((trait, i) => {
          const angle = i * angleSlice - Math.PI / 2;
          svg.append("line")
            .attr("x1", 0).attr("y1", 0)
            .attr("x2", radius * Math.cos(angle))
            .attr("y2", radius * Math.sin(angle))
            .attr("stroke", "#ccc");

          svg.append("text")
            .attr("x", (radius + 20) * Math.cos(angle))
            .attr("y", (radius + 20) * Math.sin(angle))
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .text(trait);
        });

        const line = d3.lineRadial()
          .radius(d => radius * (d.value + 1) / 2)  // map -1 to 1 → 0 to radius
          .angle((d, i) => i * angleSlice)
          .curve(d3.curveLinearClosed);

        // Draw radar lines
        datasets.forEach((dataset, i) => {
          const color = colorScale(dataset.name);

          svg.append("path")
            .datum(dataset.values)
            .attr("d", line)
            .attr("fill", "none")
            .attr("stroke", color)
            .attr("stroke-width", 2);

          // Dots on each point
          svg.selectAll(`.dot-${i}`)
            .data(dataset.values)
            .enter()
            .append("circle")
            .attr("cx", (d, j) => (radius * (d.value + 1) / 2) * Math.cos(j * angleSlice - Math.PI / 2))
            .attr("cy", (d, j) => (radius * (d.value + 1) / 2) * Math.sin(j * angleSlice - Math.PI / 2))
            .attr("r", 4)
            .attr("fill", d => d.significant ? color : "#999")
            .attr("stroke", d => d.significant ? "white" : "#666")
            .attr("stroke-width", d => d.significant ? 1 : 1)
            .attr("opacity", 0.8)
            .style("stroke-dasharray", d => d.significant ? "0" : "2,2");
        });
      }

      function drawLegend(datasets) {
        const legend = d3.select("#legend");
        legend.html("");

        datasets.forEach((ds, i) => {
          legend.append("div")
            .style("color", colorScale(ds.name))
            .style("font-weight", "bold")
            .style("margin-bottom", "5px")
            .text(`⬤ ${ds.name}`);
        });

        legend.append("div").style("margin-top", "10px").html(`
          <small><strong>Dot color:</strong> significant (p < 0.05) in color, otherwise gray.<br>
          <strong>Ctrl/Cmd + Click</strong> to compare features.</small>
        `);
      }
    });
  </script>
</body>

</html>